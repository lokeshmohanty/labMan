<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ lab_name }} Management{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Theme Switcher - Load early to prevent flash -->
    <script src="{{ url_for('static', filename='js/theme-switcher.js') }}"></script>
</head>

<body>
    {% if session.user_id %}
    <nav class="navbar">
        <div class="navbar-container">
            <a href="{{ url_for('dashboard') }}" class="navbar-brand">{{ lab_name }}</a>
            <ul class="navbar-menu">
                <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('users') }}">Members</a></li>
                <li><a href="{{ url_for('groups') }}">Groups</a></li>
                <li><a href="{{ url_for('research') }}">Research</a></li>
                <li><a href="{{ url_for('meetings') }}">Meetings</a></li>
                <li><a href="{{ url_for('content') }}">Content</a></li>
                <li><a href="{{ url_for('inventory') }}">Inventory</a></li>
                <li>
                    <button id="theme-toggle" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; 
                                   padding: 0.5rem 1rem; border-radius: 12px; transition: all 0.3s ease;"
                        aria-label="Toggle theme" title="Toggle theme">
                        <span class="theme-icon">ðŸŒ™</span>
                    </button>
                </li>
                <li style="position: relative;">
                    <a href="#" style="cursor: pointer;" onclick="toggleDropdown(event)">
                        Profile â–¾
                    </a>
                    <ul id="profileDropdown" style="display: none; position: absolute; top: 100%; right: 0; 
                                                       background: var(--primary-dark); min-width: 200px; 
                                                       list-style: none; padding: 0.5rem 0; border-radius: 12px;
                                                       box-shadow: 0 6px 16px rgba(0,0,0,0.15); z-index: 1000;">
                        <li><a href="{{ url_for('edit_profile') }}" style="display: block; padding: 0.5rem 1rem;">Edit
                                Profile</a></li>
                        <li><a href="{{ url_for('change_password') }}"
                                style="display: block; padding: 0.5rem 1rem;">Change Password</a></li>
                        <li><a href="{{ url_for('history_route') }}"
                                style="display: block; padding: 0.5rem 1rem;">Activity
                                History</a></li>
                        <li><a href="{{ url_for('logout') }}" style="display: block; padding: 0.5rem 1rem;">Logout</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>
    {% endif %}

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <div id="gantt-tooltip" class="gantt-tooltip" style="display: none;"></div>

    <script>
        function toggleDropdown(event) {
            event.preventDefault();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('profileDropdown');
            const isClickInside = event.target.closest('li');
            if (!isClickInside && dropdown) {
                dropdown.style.display = 'none';
            }
        });

        // Gantt Chart Tooltip Logic
        document.addEventListener('DOMContentLoaded', () => {
            const tooltip = document.getElementById('gantt-tooltip');

            document.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('gantt-bar')) {
                    const name = e.target.dataset.taskName;
                    const status = e.target.dataset.status;
                    const start = e.target.dataset.start;
                    const end = e.target.dataset.end;

                    if (name) {
                        tooltip.innerHTML = `
                            <strong>${name}</strong><br>
                            <span style="font-size: 0.8rem; opacity: 0.9;">Status: ${status}</span><br>
                            <span style="font-size: 0.8rem; opacity: 0.9;">${start} to ${end}</span>
                        `;
                        tooltip.style.display = 'block';
                    }
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (tooltip.style.display === 'block') {
                    // Position tooltip near cursor but slightly offset to not block view
                    // Ensure it doesn't go off screen (basic check)
                    let left = e.pageX + 15;
                    let top = e.pageY + 15;

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }
            });

            document.addEventListener('mouseout', (e) => {
                if (e.target.classList.contains('gantt-bar')) {
                    tooltip.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>